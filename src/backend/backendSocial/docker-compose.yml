services:
  identity-service:
    build:
      context: ./identity
      dockerfile: Dockerfile
    container_name: identity-service
    ports:
      - "8000:8000"
    environment:
      PORT: 8000
      PROFILE_SERVICE_URL: http://profile-service:8081/profiles
      POST_SERVICE_URL: http://post-service:8082/posts
      DATABASE_URL: jdbc:postgresql://aws-1-ap-south-1.pooler.supabase.com:6543/postgres?sslmode=require&prepareThreshold=0&preparedStatementCacheQueries=0&preferQueryMode=simple&connectTimeout=30&socketTimeout=30&loginTimeout=30
      DATABASE_USERNAME: postgres.noyltxzqpksuzxmjonkm
      DATABASE_PASSWORD: Cong2642005@@
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      COOKIE_SECURE: ${COOKIE_SECURE:-false}
      COOKIE_SAME_SITE: ${COOKIE_SAME_SITE:-Lax}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN:-}
      REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND: ${REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND:-http://localhost:5173/google-loading}
      REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND_FAILURE: ${REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND_FAILURE:-http://localhost:5173/failure}
      REDIRECT_URI: ${REDIRECT_URI:-http://localhost:5173/google-loading}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID:-}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET:-}
      FACEBOOK_REDIRECT_URI: ${FACEBOOK_REDIRECT_URI:-http://localhost:5173/facebook-loading}
    depends_on:
      - profile-service
      - post-service
    networks:
      - backend-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  post-service:
    build:
      context: ./post
      dockerfile: Dockerfile
    container_name: post-service
    ports:
      - "8082:8082"
    environment:
      PORT: 8082
      DATABASE_URL: jdbc:postgresql://aws-1-ap-south-1.pooler.supabase.com:6543/postgres?sslmode=require&prepareThreshold=0&preparedStatementCacheQueries=0&preferQueryMode=simple&connectTimeout=30&socketTimeout=30&loginTimeout=30
      DATABASE_USERNAME: postgres.noyltxzqpksuzxmjonkm
      DATABASE_PASSWORD: Cong2642005@@
    networks:
      - backend-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  profile-service:
    build:
      context: ./profile
      dockerfile: Dockerfile
    container_name: profile-service
    ports:
      - "8081:8081"
    environment:
      PORT: 8081
      DATABASE_URL: jdbc:postgresql://aws-1-ap-south-1.pooler.supabase.com:6543/postgres?sslmode=require&prepareThreshold=0&preparedStatementCacheQueries=0&preferQueryMode=simple&connectTimeout=30&socketTimeout=30&loginTimeout=30
      DATABASE_USERNAME: postgres.noyltxzqpksuzxmjonkm
      DATABASE_PASSWORD: Cong2642005@@
    networks:
      - backend-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  comments-service:
    build:
      context: ./comments
      dockerfile: Dockerfile
    container_name: comments-service
    ports:
      - "8003:8003"
    environment:
      PORT: 8003
      MONGO_URI: "mongodb+srv://LeThanhCong:LeThanhCong@mywebv1.dbl7xj4.mongodb.net/?appName=MyWebv1"
      POST_SERVICE_URL: http://post-service:8082/posts
    depends_on:
      - post-service
    networks:
      - backend-network
    restart: unless-stopped

  communication-service:
    build:
      context: ./communication
      dockerfile: Dockerfile
    container_name: communication-service
    ports:
      - "8085:8085"
      - "8899:8899"
    environment:
      PORT: 8085
      SOCKET_SERVICE_PORT: 8899
      SOCKET_SERVICE_HOST: 0.0.0.0
      IDENTITY_SERVICE_URL: http://identity-service:8000/identity
    depends_on:
      - identity-service
    networks:
      - backend-network
    restart: unless-stopped

  cognitive-service:
    build:
      context: ./cognitive-service
      dockerfile: Dockerfile
    container_name: cognitive-service
    ports:
      - "9090:9090"
    environment:
      PORT: 9090
      X_API_KEY: ${COGNITIVE_X_API_KEY:-lethanhcong}
      BASE_URL: ${COGNITIVE_BASE_URL:-aHR0cHM6Ly9hcGkuZ3JvcS5jb20=}
      API_KEYs: ${COGNITIVE_API_KEYS:-}
      ORIGIN: ${COGNITIVE_ORIGIN:-*}
      temperature: ${COGNITIVE_TEMPERATURE:-0.1}
    networks:
      - backend-network
    restart: unless-stopped

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8888:8888"
    environment:
      PORT: 8888
      IDENTITY_SERVICE_URL: http://identity-service:8000
      PROFILE_SERVICE_URL: http://profile-service:8081
      POST_SERVICE_URL: http://post-service:8082
      COMMENT_SERVICE_URL: http://comments-service:8003
      COMMUNICATION_SERVICE_URL: http://communication-service:8085
      COGNITIVE_SERVICE_URL: http://cognitive-service:9090
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL:-http://host.docker.internal:4444}
      CONFIG_HTTP_IDENTITY: http://identity-service:8000/identity
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000,https://nmcnpm.lethanhcong.site,https://nmcnpm.lethanhcong.site:46337}
    depends_on:
      - identity-service
      - profile-service
      - post-service
      - comments-service
      - communication-service
      - cognitive-service
    networks:
      - backend-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  backend-network:
    driver: bridge
