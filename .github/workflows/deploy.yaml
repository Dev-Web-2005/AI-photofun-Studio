name: "deploy"
on:
  push:
    branches: ["test"]
    tags:
      - "v*"
    paths:
      - "src/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yaml"
  pull_request:
    branches: ["master"]
    paths:
      - "src/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yaml"
  workflow_dispatch:

jobs:
  detect-changes:
    name: "Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backendAI: ${{ steps.changes.outputs.backendAI }}
      backendSocial: ${{ steps.changes.outputs.backendSocial }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changes
        run: |
          # If tag push or manual dispatch, deploy all
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Tag push or manual dispatch detected - deploying all services"
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "backendAI=true" >> $GITHUB_OUTPUT
            echo "backendSocial=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            BASE_SHA="${{ github.event.before }}"
            if [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              BASE_SHA=$(git hash-object -t tree /dev/null)
            fi
          else
            BASE_SHA="HEAD~1"
          fi
          HEAD_SHA="${{ github.sha }}"
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          echo "Changed files:"
          echo "$CHANGED_FILES"
          if echo "$CHANGED_FILES" | grep -q "^src/frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "No frontend changes"
          fi

          if echo "$CHANGED_FILES" | grep -q "^src/backend/backendAI/"; then
            echo "backendAI=true" >> $GITHUB_OUTPUT
            echo "BackendAI changes detected"
          else
            echo "backendAI=false" >> $GITHUB_OUTPUT
            echo "No backendAI changes"
          fi

          if echo "$CHANGED_FILES" | grep -q "^src/backend/backendSocial/"; then
            echo "backendSocial=true" >> $GITHUB_OUTPUT
            echo "BackendSocial changes detected"
          else
            echo "backendSocial=false" >> $GITHUB_OUTPUT
            echo "No backendSocial changes"
          fi

  deploy-backend-social:
    name: "Deploy Backend Social"
    needs: detect-changes
    if: needs.detect-changes.outputs.backendSocial == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload code to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          source: "src/backend/backendSocial/*"
          target: "/home/${{ secrets.SSH_USERNAME }}/projects/backendSocial/"
          rm: true

      - name: "Deploy Backend Social via SSH"
        env:
          GOOGLE_REDIRECT_FRONTEND: ${{ vars.GOOGLE_REDIRECT_FRONTEND }}
          GOOGLE_REDIRECT_FRONTEND_FAILURE: ${{ vars.GOOGLE_REDIRECT_FRONTEND_FAILURE }}
          CORS_ORIGINS: ${{ vars.CORS_ORIGINS }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          FACEBOOK_APP_ID: ${{ secrets.FACEBOOK_APP_ID }}
          FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_APP_SECRET }}
          COGNITIVE_PORT: ${{ vars.COGNITIVE_PORT }}
          COGNITIVE_TEMPERATURE: ${{ vars.COGNITIVE_TEMPERATURE }}
          COGNITIVE_X_API_KEY: ${{ secrets.COGNITIVE_X_API_KEY }}
          COGNITIVE_BASE_URL: ${{ secrets.COGNITIVE_BASE_URL }}
          COGNITIVE_API_KEYS: ${{ secrets.COGNITIVE_API_KEYS }}
          COGNITIVE_ORIGIN: ${{ vars.COGNITIVE_ORIGIN }}

        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 50m
          envs: GOOGLE_CLIENT_SECRET,CORS_ORIGINS,GOOGLE_REDIRECT_FRONTEND,GOOGLE_REDIRECT_FRONTEND_FAILURE,FACEBOOK_APP_ID,FACEBOOK_APP_SECRET,COGNITIVE_PORT,COGNITIVE_TEMPERATURE,COGNITIVE_X_API_KEY,COGNITIVE_BASE_URL,COGNITIVE_API_KEYS,COGNITIVE_ORIGIN
          script: |
            USER=$(whoami)
            WORKSPACE="/home/$USER/projects/backendSocial/src/backend/backendSocial"

            if [ ! -d "$WORKSPACE" ]; then
              echo "ERROR: Backend Social directory not found at $WORKSPACE"
              exit 1
            fi

            cd $WORKSPACE
            echo "Current directory: $(pwd)"

            cat > .env << EOF
            GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
            FACEBOOK_APP_ID=$FACEBOOK_APP_ID
            FACEBOOK_APP_SECRET=$FACEBOOK_APP_SECRET
            FACEBOOK_REDIRECT_URI=https://nmcnpm.lethanhcong.site:46337/facebook-loading
            CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://nmcnpm.lethanhcong.site:46337,$CORS_ORIGINS
            COOKIE_SECURE=true
            COOKIE_SAME_SITE=None
            COOKIE_DOMAIN=.lethanhcong.site
            REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND=$GOOGLE_REDIRECT_FRONTEND
            REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND_FAILURE=$GOOGLE_REDIRECT_FRONTEND_FAILURE
            REDIRECT_URI=$GOOGLE_REDIRECT_FRONTEND
            FRONTEND_URL=https://nmcnpm.lethanhcong.site:46337
            COGNITIVE_SERVICE_URL=http://cognitive-service:9090
            COGNITIVE_PORT=$COGNITIVE_PORT
            COGNITIVE_TEMPERATURE=$COGNITIVE_TEMPERATURE
            COGNITIVE_X_API_KEY=$COGNITIVE_X_API_KEY
            COGNITIVE_BASE_URL=$COGNITIVE_BASE_URL
            COGNITIVE_API_KEYS=$COGNITIVE_API_KEYS
            COGNITIVE_ORIGIN=$COGNITIVE_ORIGIN
            EOF

            echo "Environment variables for backendSocial:"
            cat .env

            sudo docker-compose down || true
            sudo docker-compose up -d --build --force-recreate

            sleep 15
            sudo docker-compose ps
            sudo docker-compose logs --tail=50 api-gateway

  deploy-backend-ai:
    name: "Deploy Backend AI"
    needs: detect-changes
    if: needs.detect-changes.outputs.backendAI == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload code to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          source: "src/backend/backendAI/*"
          target: "/home/${{ secrets.SSH_USERNAME }}/projects/backendAI/"
          rm: true

      - name: "Deploy Backend AI via SSH"
        env:
          CORS_ORIGINS: ${{ vars.CORS_ORIGINS }}
          DEBUG: ${{ vars.DEBUG }}
          GPU_DEVICE_ID: ${{ vars.GPU_DEVICE_ID }}
          MONGO_DB_NAME: ${{ vars.MONGO_DB_NAME }}
          MONGO_URI: ${{ vars.MONGO_URI }}
          SECRET_KEY: ${{ vars.SECRET_KEY }}
          TIME_ZONE: ${{ vars.TIME_ZONE }}
          USE_GPU: ${{ vars.USE_GPU }}
          USE_TZ: ${{ vars.USE_TZ }}
          MODELSTUDIO_API_BASE: ${{ vars.MODELSTUDIO_API_BASE }}
          FREEPIK_API_KEY: ${{ secrets.FREEPIK_API_KEY }}
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
          SUPABASE_DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
          SUPABASE_DB_SSLMODE: ${{ secrets.SUPABASE_DB_SSLMODE }}
          SUPABASE_DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          MODELSTUDIO_API_KEY: ${{ secrets.MODELSTUDIO_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM: ${{ secrets.JWT_ALGORITHM }}
          JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
          JWT_AUDIENCE: ${{ secrets.JWT_AUDIENCE }}
          TOKEN_SERVICE_URL: ${{ secrets.TOKEN_SERVICE_URL }}
          TOKEN_API_KEY_1: ${{ secrets.TOKEN_API_KEY_1 }}
          TOKEN_API_KEY_2: ${{ secrets.TOKEN_API_KEY_2 }}
          TOKEN_SERVICE_TIMEOUT: ${{ secrets.TOKEN_SERVICE_TIMEOUT }}

        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 50m
          envs: DEBUG,MONGO_DB_NAME,MONGO_URI,SECRET_KEY,GEMINI_API_KEYS,OPENAI_API_KEY,FREEPIK_API_KEY,SUPABASE_DB_HOST,SUPABASE_DB_NAME,SUPABASE_DB_PASSWORD,SUPABASE_DB_PORT,SUPABASE_DB_SSLMODE,SUPABASE_DB_USER,MODELSTUDIO_API_BASE,MODELSTUDIO_API_KEY,JWT_SECRET_KEY,JWT_ALGORITHM,JWT_ISSUER,JWT_AUDIENCE,TOKEN_SERVICE_URL,TOKEN_API_KEY_1,TOKEN_API_KEY_2,TOKEN_SERVICE_TIMEOUT,CORS_ORIGINS,TIME_ZONE,USE_TZ,USE_GPU,GPU_DEVICE_ID
          script: |
            USER=$(whoami)
            WORKSPACE="/home/$USER/projects/backendAI/src/backend/backendAI"

            if [ ! -d "$WORKSPACE" ]; then
              echo "ERROR: Backend AI directory not found at $WORKSPACE"
              exit 1
            fi

            cd $WORKSPACE
            echo "Current directory: $(pwd)"

            cat > .env << EOF
            DJANGO_SECRET_KEY=$SECRET_KEY
            DJANGO_DEBUG=$DEBUG
            DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,nmcnpm-api-ai.lethanhcong.site
            SUPABASE_DB_HOST=$SUPABASE_DB_HOST
            SUPABASE_DB_PORT=$SUPABASE_DB_PORT
            SUPABASE_DB_NAME=$SUPABASE_DB_NAME
            SUPABASE_DB_USER=$SUPABASE_DB_USER
            SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD
            SUPABASE_DB_SSLMODE=$SUPABASE_DB_SSLMODE
            FREEPIK_API_KEY=$FREEPIK_API_KEY
            GEMINI_API_KEYS=$GEMINI_API_KEYS
            MONGO_URI=$MONGO_URI
            MONGO_DB_NAME=$MONGO_DB_NAME
            CORS_ORIGINS=https://nmcnpm.lethanhcong.site:46337,http://localhost:5173,http://localhost:3000,$CORS_ORIGINS
            TIME_ZONE=$TIME_ZONE
            USE_TZ=$USE_TZ
            USE_GPU=$USE_GPU
            GPU_DEVICE_ID=$GPU_DEVICE_ID
            MODELSTUDIO_API_KEY=$MODELSTUDIO_API_KEY
            MODELSTUDIO_API_BASE=$MODELSTUDIO_API_BASE
            JWT_SECRET_KEY=$JWT_SECRET_KEY
            JWT_ALGORITHM=$JWT_ALGORITHM
            JWT_ISSUER=$JWT_ISSUER
            JWT_AUDIENCE=$JWT_AUDIENCE
            TOKEN_SERVICE_URL=$TOKEN_SERVICE_URL
            TOKEN_API_KEY_1=$TOKEN_API_KEY_1
            TOKEN_API_KEY_2=$TOKEN_API_KEY_2
            TOKEN_SERVICE_TIMEOUT=$TOKEN_SERVICE_TIMEOUT
            EOF

            sudo docker-compose down || true
            sudo docker-compose up -d --build --force-recreate
            sleep 10
            sudo docker exec backendai_api python import_prompts.py --file prompts.txt || echo "Prompts import failed or already imported"

            sudo docker-compose ps
            sudo docker-compose logs --tail=30 backendAI

  test-frontend:
    name: "Test Frontend"
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd src/frontend
          npm install

      - name: Run tests
        env:
          DEPLOY_PATH: "/var/www/html/nmcnpm.lethanhcong.site/"
          BRANCH: "test"

          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_REDIRECT_URI: ${{ vars.VITE_GOOGLE_REDIRECT_URI }}
          VITE_SOCIAL_GATWAY_API_URL: ${{ vars.VITE_SOCIAL_GATWAY_API_URL }}
          VITE_TURN_CREDENTIAL_1: ${{ vars.VITE_TURN_CREDENTIAL_1 }}
          VITE_TURN_CREDENTIAL_2: ${{ vars.VITE_TURN_CREDENTIAL_2 }}
          VITE_TURN_URL_1: ${{ vars.VITE_TURN_URL_1 }}
          VITE_TURN_URL_2: ${{ vars.VITE_TURN_URL_2 }}
          VITE_TURN_USERNAME_1: ${{ vars.VITE_TURN_USERNAME_1 }}
          VITE_TURN_USERNAME_2: ${{ vars.VITE_TURN_USERNAME_2 }}
          VITE_API_GATEWAY: ${{ vars.VITE_API_GATEWAY }}
          VITE_AI_API_URL: ${{ vars.VITE_AI_API_URL }}
          VITE_SOCKET_URL: ${{ vars.VITE_SOCKET_URL }}
          VITE_SOCKET_COMMENT_URL: ${{ vars.VITE_SOCKET_COMMENT_URL }}
          VITE_COMMENT_API_URL: ${{ vars.VITE_COMMENT_API_URL }}
          VITE_PAYMENT_API_URL: ${{ vars.VITE_PAYMENT_API_URL }}
          VITE_FILE_UPLOAD_URL: ${{ vars.VITE_FILE_UPLOAD_URL }}
          VITE_CHATBOT_API_URL: ${{ vars.VITE_CHATBOT_API_URL }}

          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_PAYMENT_API_KEY: ${{ secrets.VITE_PAYMENT_API_KEY }}
          VITE_CHATBOT_BEARER_TOKEN: ${{ secrets.VITE_CHATBOT_BEARER_TOKEN }}
          VITE_CHATBOT_USER_ID: ${{ secrets.VITE_CHATBOT_USER_ID }}
          VITE_CHATBOT_X_API_KEY: ${{ secrets.VITE_CHATBOT_X_API_KEY }}
          VITE_COGNITIVE_API_URL: ${{ vars.VITE_COGNITIVE_API_URL }}
        run: |
          set -e
          cd src/frontend
          npm run build

  deploy-frontend:
    name: "Deploy Frontend"
    needs: test-frontend
    if: needs.test-frontend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Move code to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          source: "src/frontend/*"
          target: "/home/${{ secrets.SSH_USERNAME }}/projects/frontend/"

      - name: "Deploy Frontend via SSH"
        env:
          DEPLOY_PATH: "/var/www/html/nmcnpm.lethanhcong.site/"

          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_REDIRECT_URI: ${{ vars.VITE_GOOGLE_REDIRECT_URI }}
          VITE_SOCIAL_GATWAY_API_URL: ${{ vars.VITE_SOCIAL_GATWAY_API_URL }}
          VITE_TURN_CREDENTIAL_1: ${{ vars.VITE_TURN_CREDENTIAL_1 }}
          VITE_TURN_CREDENTIAL_2: ${{ vars.VITE_TURN_CREDENTIAL_2 }}
          VITE_TURN_URL_1: ${{ vars.VITE_TURN_URL_1 }}
          VITE_TURN_URL_2: ${{ vars.VITE_TURN_URL_2 }}
          VITE_TURN_USERNAME_1: ${{ vars.VITE_TURN_USERNAME_1 }}
          VITE_TURN_USERNAME_2: ${{ vars.VITE_TURN_USERNAME_2 }}
          VITE_API_GATEWAY: ${{ vars.VITE_API_GATEWAY }}
          VITE_AI_API_URL: ${{ vars.VITE_AI_API_URL }}
          VITE_SOCKET_URL: ${{ vars.VITE_SOCKET_URL }}
          VITE_SOCKET_COMMENT_URL: ${{ vars.VITE_SOCKET_COMMENT_URL }}
          VITE_COMMENT_API_URL: ${{ vars.VITE_COMMENT_API_URL }}
          VITE_PAYMENT_API_URL: ${{ vars.VITE_PAYMENT_API_URL }}
          VITE_FILE_UPLOAD_URL: ${{ vars.VITE_FILE_UPLOAD_URL }}
          VITE_CHATBOT_API_URL: ${{ vars.VITE_CHATBOT_API_URL }}

          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_PAYMENT_API_KEY: ${{ secrets.VITE_PAYMENT_API_KEY }}
          VITE_CHATBOT_BEARER_TOKEN: ${{ secrets.VITE_CHATBOT_BEARER_TOKEN }}
          VITE_CHATBOT_USER_ID: ${{ secrets.VITE_CHATBOT_USER_ID }}
          VITE_CHATBOT_X_API_KEY: ${{ secrets.VITE_CHATBOT_X_API_KEY }}
          VITE_COGNITIVE_API_URL: ${{ vars.VITE_COGNITIVE_API_URL }}

        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 50m
          envs: DEPLOY_PATH,BRANCH,VITE_GOOGLE_CLIENT_ID,VITE_GOOGLE_REDIRECT_URI,VITE_SOCIAL_GATWAY_API_URL,VITE_TURN_CREDENTIAL_1,VITE_TURN_CREDENTIAL_2,VITE_TURN_URL_1,VITE_TURN_URL_2,VITE_TURN_USERNAME_1,VITE_TURN_USERNAME_2,VITE_API_GATEWAY,VITE_AI_API_URL,VITE_FILE_UPLOAD_URL,VITE_SOCKET_URL,VITE_SOCKET_COMMENT_URL,VITE_COMMENT_API_URL,VITE_PAYMENT_API_URL,VITE_CHATBOT_API_URL,VITE_FIREBASE_API_KEY,VITE_FIREBASE_APP_ID,VITE_FIREBASE_AUTH_DOMAIN,VITE_FIREBASE_MEASUREMENT_ID,VITE_FIREBASE_MESSAGING_SENDER_ID,VITE_FIREBASE_PROJECT_ID,VITE_FIREBASE_STORAGE_BUCKET,VITE_PAYMENT_API_KEY,VITE_CHATBOT_BEARER_TOKEN,VITE_CHATBOT_USER_ID,VITE_CHATBOT_X_API_KEY,VITE_COGNITIVE_API_URL
          script: |
            USER=$(whoami)
            echo "Current user: $USER"

            # Check directory structure after scp
            echo "Checking /home/$USER/projects/frontend structure:"
            ls -la "/home/$USER/projects/frontend/" || echo "Directory does not exist"

            # Check if files are in src/frontend subdirectory
            if [ -d "/home/$USER/projects/frontend/src/frontend" ]; then
              echo "Files are in src/frontend subdirectory"
              WORKSPACE="/home/$USER/projects/frontend/src/frontend"
            elif [ -f "/home/$USER/projects/frontend/package.json" ]; then
              echo "Files are directly in frontend directory"
              WORKSPACE="/home/$USER/projects/frontend"
            else
              echo "ERROR: Cannot find package.json in expected locations"
              echo "Directory contents:"
              find "/home/$USER/projects/frontend" -name "package.json" 2>/dev/null || echo "No package.json found"
              exit 1
            fi

            echo "Using WORKSPACE: $WORKSPACE"
            cd "$WORKSPACE"
            echo "Current directory after cd: $(pwd)"
            echo "Verifying package.json exists:"
            ls -la package.json

            if [ -d "node_modules" ]; then
              rm -rf node_modules
            fi

            cat > .env << EOF
            VITE_GOOGLE_CLIENT_ID=$VITE_GOOGLE_CLIENT_ID
            VITE_GOOGLE_REDIRECT_URI=$VITE_GOOGLE_REDIRECT_URI
            VITE_API_GATEWAY=$VITE_API_GATEWAY
            VITE_AI_API_URL=$VITE_AI_API_URL
            VITE_SOCKET_URL=$VITE_SOCKET_URL
            VITE_SOCKET_COMMENT_URL=$VITE_SOCKET_COMMENT_URL
            VITE_COMMENT_API_URL=$VITE_COMMENT_API_URL
            VITE_FILE_UPLOAD_URL=$VITE_FILE_UPLOAD_URL
            VITE_SOCIAL_GATWAY_API_URL=$VITE_SOCIAL_GATWAY_API_URL
            VITE_TURN_CREDENTIAL_1=$VITE_TURN_CREDENTIAL_1
            VITE_TURN_CREDENTIAL_2=$VITE_TURN_CREDENTIAL_2
            VITE_TURN_URL_1=$VITE_TURN_URL_1
            VITE_TURN_URL_2=$VITE_TURN_URL_2
            VITE_TURN_USERNAME_1=$VITE_TURN_USERNAME_1
            VITE_TURN_USERNAME_2=$VITE_TURN_USERNAME_2
            VITE_FIREBASE_API_KEY=$VITE_FIREBASE_API_KEY
            VITE_FIREBASE_APP_ID=$VITE_FIREBASE_APP_ID
            VITE_FIREBASE_AUTH_DOMAIN=$VITE_FIREBASE_AUTH_DOMAIN
            VITE_FIREBASE_DATABASE_URL=https://ai-photofun-studio-default-rtdb.firebaseio.com
            VITE_FIREBASE_MEASUREMENT_ID=$VITE_FIREBASE_MEASUREMENT_ID
            VITE_FIREBASE_MESSAGING_SENDER_ID=$VITE_FIREBASE_MESSAGING_SENDER_ID
            VITE_FIREBASE_PROJECT_ID=$VITE_FIREBASE_PROJECT_ID
            VITE_FIREBASE_STORAGE_BUCKET=$VITE_FIREBASE_STORAGE_BUCKET
            VITE_PAYMENT_API_URL=$VITE_PAYMENT_API_URL
            VITE_PAYMENT_API_KEY=$VITE_PAYMENT_API_KEY
            VITE_CHATBOT_API_URL=$VITE_CHATBOT_API_URL
            VITE_CHATBOT_X_API_KEY=$VITE_CHATBOT_X_API_KEY
            VITE_CHATBOT_USER_ID=$VITE_CHATBOT_USER_ID
            VITE_CHATBOT_BEARER_TOKEN=$VITE_CHATBOT_BEARER_TOKEN
            VITE_COGNITIVE_API_URL=$VITE_COGNITIVE_API_URL
            EOF

            set -e
            npm install --prefer-offline --no-audit
            npm run build

            if [ ! -d "dist" ]; then
              echo "ERROR: Build failed - dist directory not found"
              exit 1
            fi

            rm -rf $DEPLOY_PATH/*
            cp -r dist/* $DEPLOY_PATH
            sudo systemctl restart nginx
